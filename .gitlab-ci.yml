image: thomaschln/r-devtools

# gitlab-ci file copied from https://www.r-bloggers.com/developing-r-packages-with-usethis-and-gitlab-ci-part-iii/

variables:
  R_LIBS_DIR: "$CI_PROJECT_DIR/ci/lib"
  CHECK_DIR: "$CI_PROJECT_DIR/ci/logs"
  BUILD_LOGS_DIR: "$CI_PROJECT_DIR/ci/logs/$CI_PROJECT_NAME.Rcheck"

cache:
  paths:
  - $R_LIBS_DIR

before_script:
  - export R_LIBS_USER=$R_LIBS_DIR/$(R --version | sed -n 1p| sed -r 's/.*([0-9]\.[0-9]\.[0-9]).*/\1/')
  # - R -e 'R_LIBS_USER=file.path(Sys.getenv("R_LIBS_DIR"), strsplit(version[["version.string"]], " ")[[1]][3]); Sys.setenv(R_LIBS_USER = R_LIBS_USER)'
  - R -e 'print(Sys.getenv("R_LIBS_USER"))'
  - ls $R_LIBS_DIR
  - echo '.libPaths("'${R_LIBS_USER}'")' > .Rprofile
  - apt-get update
  - apt-get install -y qpdf pandoc

stages:
  - deps
  - check
  - deploy

deps:
  stage: deps
  script:
  - echo $R_LIBS_USER
  - mkdir -p $R_LIBS_USER $BUILD_LOGS_DIR
  - ls $R_LIBS_DIR
  - R -e 'remotes::install_cran("liquidSVM", repos="http://pnp.mathematik.uni-stuttgart.de/isa/steinwart/software/R", build_opts="--no-multiarch", lib=Sys.getenv("R_LIBS_USER"))'
  - R -e 'lib=Sys.getenv("R_LIBS_USER"); print(lib); remotes::install_deps(lib=lib, dependencies=T)'

check:
  stage: check
  script:
  - R -e 'devtools::check(check_dir = Sys.getenv("CHECK_DIR"), error_on = "warning")'
  - R -e 'devtools::install()'

pages:
  stage: deploy
  script:
  - R -e 'remotes::install_github("r-lib/pkgdown", lib=Sys.getenv("R_LIBS_USER"))'
  - R -e 'devtools::document()'
  - R -e 'pkgdown::build_site()'
  # - grep gitlab docs/reference/PRO4SAIL.html
  - mv docs public
  artifacts:
    paths:
    - public

  only:
  - master

